{% extends "base.html" %}

{% block css_style %}
<link rel="stylesheet" href="../static/css/notifications.css">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
    <div class="w-100">
        <h1 class="h2">Notifications</h1>
        <p class="text-muted">Stay updated on your issue reports</p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <form class="needs-validation" action="{{ url_for('notifications') }}" method="post">
                <div class="row g-3">
                    <div class="col-12">
                        <button class="btn btn-outline-success btn-sm" id="mark-all-read">
                            <i class="bi bi-check-all"></i> Mark All Read
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- Main Notifications Panel -->
        <div class="col-lg-8 col-md-7">
            <!-- Notifications List -->
            <div class="notifications-list">
                {% if notifications %}
                    {% for notification in notifications %}
                    <div class="notification-item mb-3 rounded position-relative {{ 'notification-unread' if not notification.is_read else '' }} {{ notification.type.replace('_', '-') }}">
                        <div class="d-flex">
                            <!-- Dynamic icon based on notification type -->
                            <div class="notification-icon me-3">
                                {% if notification.type == 'status_update' %}
                                    <i class="bi bi-arrow-clockwise icon-status"></i>
                                {% elif notification.type == 'issue_resolved' %}
                                    <i class="bi bi-check-circle icon-resolved"></i>
                                {% elif notification.type == 'report_received' %}
                                    <i class="bi bi-bell icon-received"></i>
                                {% elif notification.type == 'new_comment' %}
                                    <i class="bi bi-chat-left icon-comment"></i>
                                {% elif notification.type == 'completion_delayed' %}
                                    <i class="bi bi-clock icon-delayed"></i>
                                {% elif notification.type == 'report_assigned' %}
                                    <i class="bi bi-person-check icon-assigned"></i>
                                {% else %}
                                    <i class="bi bi-info-circle icon-default"></i>
                                {% endif %}
                            </div>
                            
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ notification.title }}
                                            {% if not notification.is_read %}
                                                <span class="badge bg-dark ms-1">●</span>
                                            {% endif %}
                                        </h6>
                                        <p class="mb-1 text-muted">{{ notification.message }}</p>
                                        <small class="text-muted">
                                            {{ notification.created_at|timeago }}
                                            {% if notification.report_id %}
                                                • Report #{{ notification.report_id }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    
                                    <!-- Actions dropdown -->
                                    <div class="dropdown">
                                        <button class="btn btn-link btn-sm text-muted" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% if not notification.is_read %}
                                            <li>
                                                <a class="dropdown-item mark-read" href="#" data-notification-id="{{ notification.id }}">
                                                    <i class="bi bi-check me-2"></i>Mark as Read
                                                </a>
                                            </li>
                                            {% endif %}
                                            <li>
                                                <a class="dropdown-item text-danger delete-notification" href="#" data-notification-id="{{ notification.id }}">
                                                    <i class="bi bi-trash me-2"></i>Delete
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Empty state -->
                    <div class="text-center py-5">
                        <i class="bi bi-bell-slash" style="font-size: 3rem; color: #6c757d;"></i>
                        <h4 class="mt-3 text-muted">No notifications yet</h4>
                        <p class="text-muted">When you submit reports, you'll receive updates here.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="col-lg-4 col-md-5 bg-light p-4">
            <h5 class="mb-4">Notification Settings</h5>

            <!-- Email Notifications -->
            <div class="mb-4">
                <h6 class="mb-3">Email Notifications</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-0">Receive updates via email</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                    </div>
                </div>
            </div>

            <!-- Push Notifications -->
            <div class="mb-4">
                <h6 class="mb-3">Push Notifications</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-0">Browser notifications</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="push-notifications" checked>
                    </div>
                </div>
            </div>

            <!-- Notification Types -->
            <div class="mb-4">
                <h6 class="mb-3">Notification Types</h6>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <strong>Status Updates</strong>
                        <p class="mb-0 text-muted small">Report progress changes</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="status-updates" checked>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <strong>Comments</strong>
                        <p class="mb-0 text-muted small">New comments on reports</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="comments" checked>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Resolutions</strong>
                        <p class="mb-0 text-muted small">When issues are resolved</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="resolutions" checked>
                    </div>
                </div>
            </div>

            <!-- Notification Summary -->
            <div class="mb-4">
                <h6 class="mb-3">Notification Summary</h6>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Total</span>
                    <span class="fw-bold">{{ notifications|length }}</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Unread</span>
                    <span class="notification-summary-badge">{{ notifications|selectattr('is_read', 'equalto', False)|list|length }}</span>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <span>This Week</span>
                    <span class="fw-bold">{{ notifications|selectattr('created_at', 'ge', (moment().startOf('week')))|list|length if moment else 0 }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    // Mark all as read functionality
    document.getElementById('mark-all-read').addEventListener('click', function (e) {
        e.preventDefault();
        
        // Here you would make an AJAX call to mark all notifications as read
        fetch('/mark_all_notifications_read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const unreadItems = document.querySelectorAll('.notification-unread');
                unreadItems.forEach(item => {
                    item.classList.remove('notification-unread');
                    // Remove unread badge
                    const badge = item.querySelector('.badge.bg-dark');
                    if (badge) badge.remove();
                });
                
                // Update unread count in summary
                document.querySelector('.notification-summary-badge').textContent = '0';
                
                // Show success message
                alert('All notifications marked as read');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to mark notifications as read');
        });
    });

    // Individual notification actions
    document.addEventListener('click', function(e) {
        // Mark as read functionality
        if (e.target.closest('.mark-read')) {
            e.preventDefault();
            const link = e.target.closest('.mark-read');
            const notificationId = link.getAttribute('data-notification-id');
            
            fetch(`/mark_notification_read/${notificationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notification = link.closest('.notification-item');
                    notification.classList.remove('notification-unread');
                    
                    // Remove unread badge
                    const badge = notification.querySelector('.badge.bg-dark');
                    if (badge) badge.remove();
                    
                    // Remove "Mark as Read" option from dropdown
                    link.parentElement.remove();
                    
                    // Update unread count
                    const currentUnread = parseInt(document.querySelector('.notification-summary-badge').textContent);
                    document.querySelector('.notification-summary-badge').textContent = Math.max(0, currentUnread - 1);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to mark notification as read');
            });
        }
        
        // Delete functionality
        if (e.target.closest('.delete-notification')) {
            e.preventDefault();
            if (confirm('Are you sure you want to delete this notification?')) {
                const link = e.target.closest('.delete-notification');
                const notificationId = link.getAttribute('data-notification-id');
                
                fetch(`/delete_notification/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const notification = link.closest('.notification-item');
                        const wasUnread = notification.classList.contains('notification-unread');
                        
                        notification.style.opacity = '0.5';
                        setTimeout(() => {
                            notification.remove();
                            
                            // Update counts
                            const totalItems = document.querySelectorAll('.notification-item').length;
                            document.querySelector('.mb-4:last-child .d-flex:nth-child(2) .fw-bold').textContent = totalItems;
                            
                            if (wasUnread) {
                                const currentUnread = parseInt(document.querySelector('.notification-summary-badge').textContent);
                                document.querySelector('.notification-summary-badge').textContent = Math.max(0, currentUnread - 1);
                            }
                        }, 300);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete notification');
                });
            }
        }
    });

    // Toggle switch animations
    document.querySelectorAll('.form-check-input').forEach(toggle => {
        toggle.addEventListener('change', function () {
            this.style.transform = 'scale(0.85)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });
    });
</script>
{% endblock %}