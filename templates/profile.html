{% extends "base.html" %}

{% block css_style %}
<link rel="stylesheet" href="../static/css/profile.css">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3">
    <div class="w-100">
        <h1 class="h2">Profile & Settings</h1>
        <p class="text-muted">Manage your account and preferences</p>
    </div>
</div>
<div class="container-fluid py-4">
    <div class="row">
        <!-- Left Column - Profile Information -->
        <div class="col-lg-8">
            <!-- Personal Information -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Personal Information</h5>
                    <div>
                        <button id="editBtn" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button id="saveBtn" class="btn btn-sm btn-success d-none">
                            <i class="bi bi-check"></i> Save
                        </button>
                        <button id="cancelBtn" class="btn btn-sm btn-secondary d-none">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-start mb-4">
                        <div class="profile-avatar me-3">
                            DU
                        </div>
                        <div class="flex-grow-1">
                            <div id="nameDisplay">
                                <h4 class="mb-1">{{ current_user.full_name }}</h4>
                            </div>
                            <div id="nameEdit" class="d-none mb-2">
                                <input type="text" class="form-control" id="nameInput" value="{{ current_user.full_name }}">
                            </div>
                            <p class="text-muted mb-1">Member since {{ current_user.created_at.strftime("%B %d, %Y") }}</p>
                            <span class="badge-success">Active Citizen</span>
                        </div>
                    </div>

                    <form id="profileForm">
                        <div class="row">
                            <div class="col-md-12">
                                <!-- Email -->
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-envelope me-1"></i>
                                        Email Address
                                    </div>
                                    <div id="emailDisplay" class="info-value">{{ current_user.email }}</div>
                                    <div id="emailEdit" class="d-none">
                                        <input type="email" class="form-control" id="emailInput" value="{{ current_user.email }}">
                                    </div>
                                </div>
                                
                                <!-- Phone -->
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-telephone me-1"></i>
                                        Phone Number
                                    </div>
                                    <div id="phoneDisplay" class="info-value">{{ current_user.phone }}</div>
                                    <div id="phoneEdit" class="d-none">
                                        <input type="tel" class="form-control" id="phoneInput" value="{{ current_user.phone }}">
                                    </div>
                                </div>
                                
                                <!-- Address -->
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        Address
                                    </div>
                                    <div id="addressDisplay" class="info-value">{{ current_user.address }}</div>
                                    <div id="addressEdit" class="d-none">
                                        <textarea class="form-control" id="addressInput" rows="2">{{ current_user.address }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Loading and Error Messages -->
                    <div id="loadingMessage" class="alert alert-info d-none mt-3">
                        <i class="bi bi-arrow-repeat spin"></i> Saving changes...
                    </div>
                    <div id="successMessage" class="alert alert-success d-none mt-3">
                        <i class="bi bi-check-circle"></i> Profile updated successfully!
                    </div>
                    <div id="errorMessage" class="alert alert-danger d-none mt-3">
                        <i class="bi bi-exclamation-circle"></i> <span id="errorText">An error occurred while saving.</span>
                    </div>
                </div>
            </div>

            <!-- Preferences -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Preferences</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-translate me-1"></i>
                                    Language
                                </label>
                                <p class="text-muted small mb-2">Select your preferred language</p>
                                <select class="form-select">
                                    <option selected>English</option>
                                    <option>Spanish</option>
                                    <option>French</option>
                                    <option>German</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-palette me-1"></i>
                                    Theme
                                </label>
                                <p class="text-muted small mb-2">Choose your interface theme</p>
                                <select class="form-select">
                                    <option selected>System</option>
                                    <option>Light</option>
                                    <option>Dark</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Privacy & Notifications -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Privacy & Notifications</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Configure your privacy settings and notification preferences.</p>
                    <button class="btn btn-outline-primary">Manage Settings</button>
                </div>
            </div>
        </div>

        <!-- Right Column - Activity & Actions -->
        <div class="col-lg-4">
            <!-- Activity Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Activity Summary</h5>
                </div>
                <div class="card-body">
                    <div class="activity-item">
                        <span class="activity-label">Total Reports</span>
                        <span class="activity-value">4</span>
                    </div>
                    <div class="activity-item">
                        <span class="activity-label">Issues Resolved</span>
                        <span class="activity-value">1</span>
                    </div>
                    <div class="activity-item">
                        <span class="activity-label">Community Points</span>
                        <span class="activity-value">120</span>
                    </div>
                    <div class="activity-item">
                        <span class="activity-label">Success Rate</span>
                        <span class="activity-value">25%</span>
                    </div>
                </div>
            </div>

            <!-- Account Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Account Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="#" class="action-btn">
                            <i class="bi bi-download"></i>
                            Export Data
                        </a>
                        <a href="#" class="action-btn">
                            <i class="bi bi-key"></i>
                            Change Password
                        </a>
                        <a href="#" class="action-btn logout">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->
<script>
    // Profile editing functionality
    class ProfileEditor {
        constructor() {
            this.editBtn = document.getElementById('editBtn');
            this.saveBtn = document.getElementById('saveBtn');
            this.cancelBtn = document.getElementById('cancelBtn');
            this.profileForm = document.getElementById('profileForm');

            this.originalData = {};
            this.isEditing = false;

            this.init();
        }

        init() {
            this.editBtn.addEventListener('click', () => this.enableEdit());
            this.saveBtn.addEventListener('click', () => this.saveProfile());
            this.cancelBtn.addEventListener('click', () => this.cancelEdit());

            // Store original data
            this.storeOriginalData();
        }

        storeOriginalData() {
            this.originalData = {
                name: document.getElementById('nameInput').value,
                email: document.getElementById('emailInput').value,
                phone: document.getElementById('phoneInput').value,
                address: document.getElementById('addressInput').value
            };
        }

        enableEdit() {
            this.isEditing = true;

            // Toggle buttons
            this.editBtn.classList.add('d-none');
            this.saveBtn.classList.remove('d-none');
            this.cancelBtn.classList.remove('d-none');

            // Show edit fields, hide display fields
            this.toggleFields(true);

            // Hide any existing messages
            this.hideMessages();
        }

        async saveProfile() {
            const formData = {
                name: document.getElementById('nameInput').value,
                email: document.getElementById('emailInput').value,
                phone: document.getElementById('phoneInput').value,
                address: document.getElementById('addressInput').value
            };

            // Show loading
            this.showLoading();

            try {
                // Make API call to your Flask edit route
                const response = await fetch('/edit_profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken() // If you're using CSRF protection
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    // Update display fields with new data
                    this.updateDisplayFields(formData);

                    // Update original data
                    this.originalData = { ...formData };

                    // Exit edit mode
                    this.exitEditMode();

                    // Show success message
                    this.showSuccess();

                } else {
                    throw new Error(result.message || 'Failed to update profile');
                }

            } catch (error) {
                console.error('Error saving profile:', error);
                this.showError(error.message);
            } finally {
                this.hideLoading();
            }
        }

        cancelEdit() {
            // Restore original data
            document.getElementById('nameInput').value = this.originalData.name;
            document.getElementById('emailInput').value = this.originalData.email;
            document.getElementById('phoneInput').value = this.originalData.phone;
            document.getElementById('addressInput').value = this.originalData.address;

            // Exit edit mode
            this.exitEditMode();

            // Hide messages
            this.hideMessages();
        }

        exitEditMode() {
            this.isEditing = false;

            // Toggle buttons
            this.editBtn.classList.remove('d-none');
            this.saveBtn.classList.add('d-none');
            this.cancelBtn.classList.add('d-none');

            // Show display fields, hide edit fields
            this.toggleFields(false);
        }

        toggleFields(showEdit) {
            const fields = ['name', 'email', 'phone', 'address'];

            fields.forEach(field => {
                const display = document.getElementById(field + 'Display');
                const edit = document.getElementById(field + 'Edit');

                if (showEdit) {
                    display.classList.add('d-none');
                    edit.classList.remove('d-none');
                } else {
                    display.classList.remove('d-none');
                    edit.classList.add('d-none');
                }
            });
        }

        updateDisplayFields(data) {
            // Update name in header
            document.querySelector('h4.mb-1').textContent = data.name;

            // Update display fields
            document.getElementById('emailDisplay').textContent = data.email;
            document.getElementById('phoneDisplay').textContent = data.phone;
            document.getElementById('addressDisplay').textContent = data.address;
        }

        showLoading() {
            this.hideMessages();
            document.getElementById('loadingMessage').classList.remove('d-none');
            this.saveBtn.disabled = true;
            this.cancelBtn.disabled = true;
        }

        hideLoading() {
            document.getElementById('loadingMessage').classList.add('d-none');
            this.saveBtn.disabled = false;
            this.cancelBtn.disabled = false;
        }

        showSuccess() {
            this.hideMessages();
            document.getElementById('successMessage').classList.remove('d-none');

            // Auto-hide success message after 3 seconds
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('d-none');
            }, 3000);
        }

        showError(message) {
            this.hideMessages();
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('d-none');
        }

        hideMessages() {
            document.getElementById('loadingMessage').classList.add('d-none');
            document.getElementById('successMessage').classList.add('d-none');
            document.getElementById('errorMessage').classList.add('d-none');
        }

        getCSRFToken() {
            // If you're using Flask-WTF CSRF protection, get the token
            const token = document.querySelector('meta[name=csrf-token]');
            return token ? token.getAttribute('content') : '';
        }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize profile editor
        new ProfileEditor();

        // Handle other action buttons
        const actionBtns = document.querySelectorAll('.action-btn:not(.logout)');
        actionBtns.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                alert(`${this.textContent.trim()} functionality would be implemented here`);
            });
        });
    });
</script>
</script>
{% endblock %}